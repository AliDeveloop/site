<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قیمت بده | نرخ ارز طلا سکه کریپتو</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css">
    <style>
        body {
            font-family: 'Vazir', sans-serif;
            transition: background-color 0.5s, color 0.5s;
            padding-top: 0;
            direction: rtl;
            background-color: #0d0d0d;
            color: #ffffff;
            overflow-y: auto;
            margin-top: 60px;
        }
        .light-mode {
            background-color: #f8f9fa;
            color: #212529;
        }
        .dark-mode {
            background-color: #0d0d0d;
            color: #ffffff;
        }

        ::-webkit-scrollbar {
            width: 0px;
            z-index: -1;
        }
        ::-webkit-scrollbar-track {
            background: none;
            border-radius: 10px;
        }
        .light-mode ::-webkit-scrollbar-track {
            background: none;
        }
        ::-webkit-scrollbar-thumb {
            background: #ffffff;
            border-radius: 10px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #e0e0e0;
        }
        .light-mode ::-webkit-scrollbar-thumb {
            background: #212529;
        }
        .light-mode ::-webkit-scrollbar-thumb:hover {
            background: #333333;
        }

        .header {
            background: #1a1a1a;
            padding: 15px 0;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            z-index: 1000;
            transition: background 0.5s;
        }
        .light-mode .header {
            background: #f8f9fa;
        }
        .header h4 {
            color: #ffffff;
            margin: 0;
        }
        .light-mode .header h4 {
            color: #212529;
        }
        .header .btn {
            background: #f8f9fa;
            color: #212529;
            border: none;
            padding: 8px 15px;
            transition: background 0.3s, transform 0.3s;
        }
        .light-mode .header .btn {
            background: #0d0d0d;
            color: #ffffff;
        }
        .header .btn:hover {
            background: #4CAF50;
            color: #fff;
            transform: scale(1.05);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d0d0d;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s;
            flex-direction: column;
            gap: 20px;
        }
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-title {
            font-size: 2rem;
            color: #ffffff;
            margin-bottom: 20px;
        }
        .progress-bar-container {
            width: 300px;
            height: 20px;
            background: #333333;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0;
            transition: width 0.3s linear;
            border-radius: 10px;
        }
        .progress-text {
            font-size: 1rem;
            color: #ffffff;
            margin-top: 10px;
        }

        .quick-access-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .light-mode .quick-access-title {
            color: #212529;
        }

        .crypto-card {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 15px;
            margin: 20px auto;
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s, color 0.3s;
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-align: center;
        }
        .crypto-card.no-pointer {
            cursor: default;
        }
        .light-mode .crypto-card {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .crypto-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            background: #f8f9fa;
            color: #000000;
        }
        .light-mode .crypto-card:hover {
            background: #0d0d0d;
            color: #ffffff;
        }
        .crypto-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .currency-icon {
            margin-bottom: 5px;
        }
        .currency-logo {
            width: 40px;
            height: 40px;
            margin: 0 auto;
        }
        .currency-name {
            font-size: 1rem;
            margin: 0;
        }
        .price-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .price {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0;
        }
        .change-positive {
            color: #4CAF50;
        }
        .change-negative {
            color: #F44336;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .light-mode .section-title {
            color: #212529;
        }

        .modal-content {
            background: #1a1a1a;
            color: #ffffff;
            height: 500px;
        }
        .light-mode .modal-content {
            background: #f8f9fa;
            color: #212529;
        }
        .modal-chart {
            height: 500px;
            width: 100%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ffffff;
            margin-right: auto;
            padding: 0;
        }
        .light-mode .btn-close {
            color: #212529;
        }
        .btn-close:hover {
            color: #4CAF50;
        }

        /* استایل فوتر */
        .footer {
            background-color: #000000;
            color: #ffffff;
            padding: 20px 0;
            text-align: center;
            margin-top: 40px;
            font-size: 0.9rem;
        }
        .footer p {
            margin: 5px 0;
        }
        .footer span {
            font-family: monospace;
            word-break: break-all;
        }
        .footer a {
            color: #4CAF50;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer a:hover {
            color: #ffffff;
        }
        .light-mode .footer {
            background-color: #000000;
            color: #ffffff;
        }

        @media (max-width: 768px) {
            .crypto-card {
                margin: 10px auto;
                height: auto;
            }
            .row > .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .header {
                position: relative;
                margin-bottom: 20px;
            }
            .container {
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="loading">
        <p class="loading-title">قیمت بده | سامانه اعلام نرخ ارز سکه طلا کریپتو</p>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text" id="progressText">در حال بارگذاری... 0%</p>
    </div>

    <header class="container-fluid header d-flex justify-content-between align-items-center px-4">
        <h4>قیمت بده </h4>
        <div class="d-flex align-items-center">
            <button id="themeToggle" class="btn btn-icon"><i class="fas fa-sun"></i></button>
        </div>
    </header>

    <div class="container mt-5 pt-5">
        <div class="quick-access-title">دسترسی سریع</div>
        <div class="row" id="quickAccessContainer"></div>

        <div class="section-title">سکه و طلا</div>
        <div class="row" id="goldContainer"></div>

        <div class="section-title">ارزها</div>
        <div class="row" id="currencyContainer"></div>

        <div class="section-title">کریپتوکارنسی</div>
        <div class="row" id="cryptoContainer"></div>
    </div>

    <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">×</button>
                    <h5 class="modal-title" id="chartModalLabel"></h5>
                </div>
                <div class="modal-body">
                    <div id="tradingview_chart" class="modal-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Donate TRC20: <span>TLa7CctHRctSNYenm48Rbi2Qdmc6MzTd33</span></p>
            <p>BEP20: <span>0x6C0422B3e434F66f4AeA057d921fE82bd56b8999</span></p>
            <p>
                Contribution to the open-source community - 
                <a href="https://github.com/AliDeveloop/gheimatbede-site" target="_blank">Click to access the source code</a>
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            const icon = themeToggle.querySelector('i');
            icon.classList.toggle('fa-sun');
            icon.classList.toggle('fa-moon');
            updateChartTheme();
        });

        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        function updateProgress() {
            if (progress < 100) {
                progress += 10;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `در حال بارگذاری... ${progress}%`;
                setTimeout(updateProgress, 300);
            } else {
                hideLoading();
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.classList.add('hidden');
            setTimeout(() => loading.style.display = 'none', 500);
        }

        async function fetchUSDTIRTPrice() {
            try {
                const response = await fetch('https://api.nobitex.ir/v3/orderbook/USDTIRT');
                if (!response.ok) throw new Error('Error fetching USDTIRT price');
                const data = await response.json();
                return parseInt(data.lastTradePrice) / 10;
            } catch (error) {
                console.error('Error fetching USDTIRT:', error);
                return null;
            }
        }

        async function fetchQuickAccessPrices() {
            try {
                const goldCurrencyResponse = await fetch('https://brsapi.ir/FreeTsetmcBourseApi/Api_Free_Gold_Currency_v2.json');
                if (!goldCurrencyResponse.ok) throw new Error('Error fetching gold and currency data');
                const goldCurrencyData = await goldCurrencyResponse.json();
                const usdData = goldCurrencyData.currency.find(item => item.symbol === 'USD');
                const eurData = goldCurrencyData.currency.find(item => item.symbol === 'EUR');
                const usdPrice = usdData?.price || 'N/A';
                const usdChange = usdData?.change_percent || 'N/A';
                const eurPrice = eurData?.price || 'N/A';
                const eurChange = eurData?.change_percent || 'N/A';

                const gold18Data = goldCurrencyData.gold.find(item => item.name.includes('18 عیار') || item.symbol === '18K');
                const gold18Price = gold18Data?.price || 'N/A';
                const gold18Change = gold18Data?.change_percent || 'N/A';

                const bitcoinResponse = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin&order=market_cap_desc&per_page=1&page=1');
                if (!bitcoinResponse.ok) throw new Error('Error fetching Bitcoin price');
                const bitcoinData = await bitcoinResponse.json();
                const btcPrice = bitcoinData[0].current_price.toFixed(2) || 'N/A';
                const btcChange = bitcoinData[0].price_change_percentage_24h.toFixed(2) || 'N/A';

                return { usdPrice, usdChange, eurPrice, eurChange, gold18Price, gold18Change, btcPrice, btcChange };
            } catch (error) {
                console.error('Error fetching quick access prices:', error);
                return { usdPrice: 'N/A', usdChange: 'N/A', eurPrice: 'N/A', eurChange: 'N/A', gold18Price: 'N/A', gold18Change: 'N/A', btcPrice: 'N/A', btcChange: 'N/A' };
            }
        }

        async function fetchGoldCurrencyData() {
            try {
                const response = await fetch('https://brsapi.ir/FreeTsetmcBourseApi/Api_Free_Gold_Currency_v2.json');
                if (!response.ok) throw new Error('Error fetching gold and currency data');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching gold and currency data:', error);
                return null;
            }
        }

        const currencyFlags = {
            USD: "https://cdn-icons-png.flaticon.com/512/330/330459.png",
            EUR: "assets/photo/euro.png",
            AED: "assets/photo/uae.png",
            GBP: "https://cdn-icons-png.flaticon.com/512/330/330425.png",
            TRY: "assets/photo/turkey.png",
            CNY: "assets/photo/china.png",
            JPY: "assets/photo/japan.png",
            CAD: "assets/photo/canada.png",
            AUD: "assets/photo/australia.png",
            CHF: "assets/photo/switzerland.png",
            AFN: "assets/photo/afghanistan.png",
            IQD: "assets/photo/iraq.png",
            RUB: "assets/photo/russia.png",
            THB: "https://cdn-icons-png.flaticon.com/512/330/330447.png",
            AMD: "assets/photo/armenia.png",
            INR: "assets/photo/india.png"
        };

        async function initCryptoCards() {
            updateProgress();

            const quickAccessContainer = document.getElementById('quickAccessContainer');
            const goldContainer = document.getElementById('goldContainer');
            const currencyContainer = document.getElementById('currencyContainer');
            const cryptoContainer = document.getElementById('cryptoContainer');

            quickAccessContainer.innerHTML = goldContainer.innerHTML = currencyContainer.innerHTML = cryptoContainer.innerHTML = '<p class="text-center">در حال بارگذاری...</p>';

            const { usdPrice, usdChange, eurPrice, eurChange, gold18Price, gold18Change, btcPrice, btcChange } = await fetchQuickAccessPrices();
            const usdtIRTPrice = await fetchUSDTIRTPrice();
            const goldCurrencyData = await fetchGoldCurrencyData();

            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const cryptoData = await response.json();

                quickAccessContainer.innerHTML = `
                    <div class="col-md-3 col-12">
                        <div class="crypto-card no-pointer" data-symbol="USD">
                            <div class="crypto-content">
                                <div class="currency-icon">
                                    <img src="${currencyFlags.USD}" alt="دلار" class="currency-logo">
                                </div>
                                <p class="currency-name mb-0">دلار (USD)</p>
                                <div class="price-section">
                                    <p class="price">${usdPrice.toLocaleString('fa-IR')} تومان</p>
                                    <p class="price-change ${usdChange >= 0 ? 'change-positive' : 'change-negative'}">
                                        ${usdChange}%
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-12">
                        <div class="crypto-card no-pointer" data-symbol="EUR">
                            <div class="crypto-content">
                                <div class="currency-icon">
                                    <img src="${currencyFlags.EUR}" alt="یورو" class="currency-logo">
                                </div>
                                <p class="currency-name mb-0">یورو (EUR)</p>
                                <div class="price-section">
                                    <p class="price">${eurPrice.toLocaleString('fa-IR')} تومان</p>
                                    <p class="price-change ${eurChange >= 0 ? 'change-positive' : 'change-negative'}">
                                        ${eurChange}%
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-12">
                        <div class="crypto-card no-pointer" data-symbol="18K">
                            <div class="crypto-content">
                                <div class="currency-icon">
                                    <img src="assets/photo/gold-ingots.png" alt="طلای 18 عیار" class="currency-logo">
                                </div>
                                <p class="currency-name mb-0">طلای 18 عیار</p>
                                <div class="price-section">
                                    <p class="price">${gold18Price.toLocaleString('fa-IR')} تومان</p>
                                    <p class="price-change ${gold18Change >= 0 ? 'change-positive' : 'change-negative'}">
                                        ${gold18Change}%
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-12">
                        <div class="crypto-card" data-symbol="BTC">
                            <div class="crypto-content">
                                <div class="currency-icon">
                                    <img src="assets/photo/bitcoin.png" alt="بیت‌کوین" class="currency-logo">
                                </div>
                                <p class="currency-name mb-0">بیت‌کوین (BTC)</p>
                                <div class="price-section">
                                    <p class="price">${btcPrice} $</p>
                                    <p class="price-change ${btcChange >= 0 ? 'change-positive' : 'change-negative'}">
                                        ${btcChange}%
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>`;

                goldContainer.innerHTML = '';
                if (goldCurrencyData) {
                    goldCurrencyData.gold.forEach(item => {
                        const card = `
                            <div class="col-md-3 col-12">
                                <div class="crypto-card no-pointer" data-symbol="${item.symbol}" data-name="${item.name}">
                                    <div class="crypto-content">
                                        <div class="currency-icon">
                                            <img src="assets/photo/gold-ingots.png" alt="${item.name}" class="currency-logo">
                                        </div>
                                        <p class="currency-name mb-0">${item.name} (${item.symbol})</p>
                                        <div class="price-section">
                                            <p class="price">${item.price.toLocaleString('fa-IR')} ${item.unit}</p>
                                            <p class="price-change ${item.change_percent >= 0 ? 'change-positive' : 'change-negative'}">
                                                ${item.change_percent}%
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        goldContainer.innerHTML += card;
                    });
                }

                currencyContainer.innerHTML = '';
                if (goldCurrencyData) {
                    goldCurrencyData.currency.forEach(item => {
                        const flagUrl = currencyFlags[item.symbol] || "https://cdn-icons-png.flaticon.com/512/330/330425.png";
                        const card = `
                            <div class="col-md-3 col-12">
                                <div class="crypto-card no-pointer" data-symbol="${item.symbol}" data-name="${item.name}">
                                    <div class="crypto-content">
                                        <div class="currency-icon">
                                            <img src="${flagUrl}" alt="${item.name}" class="currency-logo">
                                        </div>
                                        <p class="currency-name mb-0">${item.name} (${item.symbol})</p>
                                        <div class="price-section">
                                            <p class="price">${item.price.toLocaleString('fa-IR')} ${item.unit}</p>
                                            <p class="price-change ${item.change_percent >= 0 ? 'change-positive' : 'change-negative'}">
                                                ${item.change_percent}%
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        currencyContainer.innerHTML += card;
                    });
                }

                cryptoContainer.innerHTML = '';
                cryptoData.forEach(crypto => {
                    const symbol = crypto.symbol.toUpperCase();
                    const priceUSD = parseFloat(crypto.current_price).toFixed(2);
                    const priceIRT = usdtIRTPrice ? (crypto.current_price * usdtIRTPrice).toLocaleString('fa-IR') : 'نامشخص';
                    const card = `
                        <div class="col-md-3 col-12">
                            <div class="crypto-card" data-symbol="${symbol}" data-name="${crypto.name}">
                                <div class="crypto-content">
                                    <div class="currency-icon">
                                        <img src="${crypto.image}" alt="${crypto.name}" class="currency-logo">
                                    </div>
                                    <p class="currency-name mb-0">${crypto.name} (${symbol})</p>
                                    <div class="price-section">
                                        <p class="price usd-price">${priceUSD} $</p>
                                        ${usdtIRTPrice ? `<p class="price irt-price">${priceIRT} تومان</p>` : ''}
                                        <p class="price-change ${crypto.price_change_percentage_24h >= 0 ? 'change-positive' : 'change-negative'}">
                                            ${parseFloat(crypto.price_change_percentage_24h).toFixed(2)}%
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    cryptoContainer.innerHTML += card;
                });

                document.querySelectorAll('.crypto-card').forEach(card => {
                    if (!card.classList.contains('no-pointer')) {
                        card.addEventListener('click', () => {
                            const symbol = card.getAttribute('data-symbol');
                            const name = card.getAttribute('data-name');
                            document.getElementById('chartModalLabel').textContent = `${name} (${symbol})`;
                            showChart(symbol);
                            const modal = new bootstrap.Modal(document.getElementById('chartModal'));
                            modal.show();
                        });
                    }
                });

            } catch (error) {
                quickAccessContainer.innerHTML = goldContainer.innerHTML = currencyContainer.innerHTML = cryptoContainer.innerHTML = `<p class="text-danger text-center">خطا: ${error.message}</p>`;
                console.error('Error:', error);
            }
        }

        async function updatePrices() {
            const usdtIRTPrice = await fetchUSDTIRTPrice();
            const goldCurrencyData = await fetchGoldCurrencyData();
            const quickAccessPrices = await fetchQuickAccessPrices();

            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const cryptoData = await response.json();

                const quickAccessCards = document.querySelectorAll('#quickAccessContainer .crypto-card');
                quickAccessCards.forEach((card, index) => {
                    switch (index) {
                        case 0:
                            card.querySelector('.price').textContent = `${quickAccessPrices.usdPrice.toLocaleString('fa-IR')} تومان`;
                            card.querySelector('.price-change').textContent = `${quickAccessPrices.usdChange}%`;
                            card.querySelector('.price-change').className = `price-change ${quickAccessPrices.usdChange >= 0 ? 'change-positive' : 'change-negative'}`;
                            break;
                        case 1:
                            card.querySelector('.price').textContent = `${quickAccessPrices.eurPrice.toLocaleString('fa-IR')} تومان`;
                            card.querySelector('.price-change').textContent = `${quickAccessPrices.eurChange}%`;
                            card.querySelector('.price-change').className = `price-change ${quickAccessPrices.eurChange >= 0 ? 'change-positive' : 'change-negative'}`;
                            break;
                        case 2:
                            card.querySelector('.price').textContent = `${quickAccessPrices.gold18Price.toLocaleString('fa-IR')} تومان`;
                            card.querySelector('.price-change').textContent = `${quickAccessPrices.gold18Change}%`;
                            card.querySelector('.price-change').className = `price-change ${quickAccessPrices.gold18Change >= 0 ? 'change-positive' : 'change-negative'}`;
                            break;
                        case 3:
                            card.querySelector('.price').textContent = `${quickAccessPrices.btcPrice} $`;
                            card.querySelector('.price-change').textContent = `${quickAccessPrices.btcChange}%`;
                            card.querySelector('.price-change').className = `price-change ${quickAccessPrices.btcChange >= 0 ? 'change-positive' : 'change-negative'}`;
                            break;
                    }
                });

                if (goldCurrencyData) {
                    goldCurrencyData.gold.forEach(item => {
                        const card = document.querySelector(`.crypto-card[data-symbol="${item.symbol}"]`);
                        if (card) {
                            card.querySelector('.price').textContent = `${item.price.toLocaleString('fa-IR')} ${item.unit}`;
                            card.querySelector('.price-change').textContent = `${item.change_percent}%`;
                            card.querySelector('.price-change').className = `price-change ${item.change_percent >= 0 ? 'change-positive' : 'change-negative'}`;
                        }
                    });
                    goldCurrencyData.currency.forEach(item => {
                        const card = document.querySelector(`.crypto-card[data-symbol="${item.symbol}"]`);
                        if (card) {
                            card.querySelector('.price').textContent = `${item.price.toLocaleString('fa-IR')} ${item.unit}`;
                            card.querySelector('.price-change').textContent = `${item.change_percent}%`;
                            card.querySelector('.price-change').className = `price-change ${item.change_percent >= 0 ? 'change-positive' : 'change-negative'}`;
                        }
                    });
                }

                cryptoData.forEach(crypto => {
                    const symbol = crypto.symbol.toUpperCase();
                    const card = document.querySelector(`.crypto-card[data-symbol="${symbol}"]`);
                    if (card) {
                        const usdPriceEl = card.querySelector('.usd-price');
                        const irtPriceEl = card.querySelector('.irt-price');
                        const changeEl = card.querySelector('.price-change');

                        usdPriceEl.textContent = `${parseFloat(crypto.current_price).toFixed(2)} $`;
                        if (irtPriceEl) irtPriceEl.textContent = `${(crypto.current_price * usdtIRTPrice).toLocaleString('fa-IR')} تومان`;
                        changeEl.textContent = `${parseFloat(crypto.price_change_percentage_24h).toFixed(2)}%`;
                        changeEl.className = `price-change ${crypto.price_change_percentage_24h >= 0 ? 'change-positive' : 'change-negative'}`;
                    }
                });
            } catch (error) {
                console.error('Error updating prices:', error);
            }
            setTimeout(updatePrices, 60000);
        }

        function showChart(symbol) {
            const chartContainer = document.getElementById('tradingview_chart');
            chartContainer.innerHTML = '';
            new TradingView.widget({
                "width": "100%",
                "height": "100%",
                "symbol": `COINEX:${symbol}USDT`, 
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": document.body.classList.contains('dark-mode') ? "dark" : "light",
                "style": "1",
                "locale": "fa",
                "toolbar_bg": document.body.classList.contains('dark-mode') ? "#1a1a1a" : "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": false,
                "container_id": "tradingview_chart"
            });
        }

        function updateChartTheme() {
            const activeCard = document.querySelector('.crypto-card.active');
            if (activeCard) {
                const symbol = activeCard.getAttribute('data-symbol');
                showChart(symbol);
            }
        }

        initCryptoCards();
    </script>
</body>
</html>